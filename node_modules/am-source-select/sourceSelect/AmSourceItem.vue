<template>
    <div class="am-source-item"  :class="{checked:info.isChecked}" :style="{marginRight:marginRight+'px'}" @click="clickHandler">
        <div class="asi-top">
            <div class="asi-thumb">
                <img v-if="info.type != 'image'" :src="info.cover"/>
                <el-image
                    ref="imagePreview"
                    v-if="info.type == 'image'"
                    style="width: 100%; height: 100%"
                    :src="info.cover" 
                    :preview-src-list="[info.preUrl]">
                </el-image>
            </div>
<!-- @click="elImageClickHandler" -->
            <div class="asi-prev-btn" @click="previewHandler">
                <!-- <div class="btn-bg"></div>
                <span>预览</span> -->
                预览
            </div>
            
            <div class="asi-icon-dura">
                <Icon :type="info.type"/>
                <div class="asi-duration">{{duration}}</div>
            </div>

            <div class="asi-checkbox" :class="{checked:info.isChecked}">
                <el-checkbox v-model="info.isChecked" @change="checkboxChangeHandler"></el-checkbox>
            </div>
        </div>
        <div class="asi-bottom">
            <div class="asi-title">{{info.title}}</div>
            <div class="asi-time-status">{{beforeTime}}</div>
        </div>

        <VAPreview ref="VApreview"/>
    </div>
</template>
<script>
import Icon from './Icon.vue';
import VAPreview from './components/VAPreview.vue';
export default {
    name:'am-source-item',
    components:{Icon,VAPreview},
    props:{
        parentWidth:{
            type:Number,
            default:0,
        },
        order:{
            type:Number,
            default:0,
        },
        info:{
            type:Object,
            default(){
                return {};
            }
        }
    },
    data(){
        return {
            dialogVisible:false,
        }
    },
    computed:{
        marginRight(){
            let curW = 208;
            const minDis = 10;//最小间距
            let num = Math.floor(this.parentWidth/(curW+minDis));
            let dis = this.parentWidth/num-curW;
            //这里为了两端对齐，需要将最右边的边距置0
            //累加余量
            dis += dis/Math.max(1,(num-1));
            if((this.order+1)%num == 0){
                dis = 0;
            }
            dis = ~~(dis*100)/100;
            return dis;
        },
        duration(){
            let dur = parseInt(this.info.duration) || 0;
            let sec = dur/1000;
        
            let h = parseInt(sec/3600);
            let m = parseInt(sec/60%60);
            let s = parseInt(sec%60);
            //let ms = parseInt(_ms%1000);
            
            let result = (h<10?"0"+h:h)+":"+(m<10?"0"+m:m)+":"+(s<10?"0"+s:s);
            return result
        },
        beforeTime(){
            let diffGmt = 0;
            if(this.info.updateTime){
                let arr = this.info.updateTime.split(' ');
                let arr1 = arr[0].split('-'),arr2 = arr[1].split(':');
                let date = new Date();
                let nowGmt = date.getTime();
                date.setFullYear(parseInt(arr1[0]),parseInt(arr1[1])-1,parseInt(arr1[2]));
                date.setHours(parseInt(arr2[0]),parseInt(arr2[1]),parseInt(arr2[2]));
                diffGmt = nowGmt - date.getTime();
                diffGmt = parseInt(diffGmt/1000);
                // parseInt(arr[0])*3600+parseInt(arr[1])*60+parseInt(arr[2]);
            }
            let msg = this.info.updateTime || '';
            if(diffGmt < 60){
                msg = diffGmt + '秒前';
            }else if(diffGmt < 3600){
                msg = Math.floor(diffGmt/60) + '分钟前';
            }else if(diffGmt < 3600*24){
                msg = Math.floor(diffGmt/3600) + '小时前';
            }
            return msg;
        }
    },
    created(){
        
    },
    mounted(){
        // console.log('this.$refs.imagePreview',this.$refs.imagePreview.$el)
    },
    methods:{
        clickHandler(){
            // this.$emit('itemclick',this.info);
            this.$emit('selected',this.info,!this.info.isChecked);
        },
        previewHandler(event){
            event.stopPropagation();
            // this.$emit('itemclick',this.info);
            if(this.info.type == 'video' || this.info.type == 'audio'){
                this.$refs.VApreview.show(this.info);
            }else if(this.info.type == 'image'){
                this.elImageClickHandler();
            }
        },
        checkboxChangeHandler(){
            this.$emit('selected',this.info,!this.info.isChecked);
        },
        elImageClickHandler(){
            
            this.$refs.imagePreview.clickHandler();
            //解决图片背景预览时，点击空余地方关闭问题
            setTimeout(()=>{
                let mask = this.$refs.imagePreview.$el.querySelector('.el-image-viewer__mask');
                if(mask){
                    mask.onclick = (event)=>{
                        event.stopPropagation();
                        this.$refs.imagePreview.closeViewer();
                    }
                }
            },100)
        }
    }
}
</script>

<style lang="scss" scoped>
.am-source-item{
    width: 208px;
    height: 181px;
    // background-color: #0000ff;
    margin-bottom: 15px;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;

    

    .asi-top{
        width: 100%;
        height: 117px;
        position: relative;
        background-color: #eeeeee;

        .asi-thumb{
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            

            >img{
                height: 100%;
                cursor: pointer;
            }

            .el-image{
                display: flex;
                justify-content: center;
                pointer-events: none;

                ::v-deep img{
                    width: initial;
                }

                ::v-deep .el-image-viewer__close{
                    color: #ffffff;
                }

                ::v-deep .el-image-viewer__wrapper{
                    pointer-events: all;
                }
            }
        }

        .asi-icon-dura{
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 30px;
            font-size: 14px;
            color: #ffffff;
            display: flex;
            align-items: center;
            padding-left: 5px;
            background-image: linear-gradient(to bottom,rgba(0,0,0,0) 0%,rgba(0,0,0,0.6) 100%);

            .icon-sitem{
                margin-right: 10px;
            }
        }

        .asi-checkbox{
            width: 14px;
            height: 14px;
            position: absolute;
            top: 10px;
            left: 10px;
            transform: scale(1.3);
            display: none;
        }

        .asi-checkbox.checked{
            display: block;
        }

        .asi-prev-btn{
            position: absolute;
            top: 10px;
            right: 10px;
            width:38px;
            height:24px;
            border-radius:2px;
            overflow: hidden;
            display: none;
            cursor: pointer;
            background:#409EFF;
            text-align: center;
            font-size: 12px;
            line-height: 24px;
            color: #ffffff;

            &:hover{
                background:#66b1ff;
            }


            // position: absolute;
            // top: 10px;
            // right: 10px;
            // width:38px;
            // height:24px;
            // border-radius:2px;
            // overflow: hidden;
            // display: none;
            // cursor: pointer;

            // .btn-bg{
            //     position: absolute;
            //     width: 100%;
            //     height: 100%;
            //     background:#000000;
            //     opacity:0.5;
            //     z-index: 0;
            // }

            // >span{
            //     position: absolute;
            //     z-index: 1;
            //     width: 100%;
            //     height: 100%;
            //     left: 0px;
            //     top: 0px;
            //     text-align: center;
            //     font-size: 12px;
            //     line-height: 24px;
            //     color: #ffffff;
            // }

            
            // &:hover{
            //     .btn-bg{
            //         background:#409EFF;
            //         opacity:1;
            //     }
            // }
        }
    }

    .asi-bottom{
        width: 100%;
        height: 64px;
        background-color: #F8F8F8;
        padding: 0 10px;

        .asi-title{
            width: 100%;
            height: 32px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            line-height: 43px;
            font-size: 14px;
            font-weight: bold;
            color: #000;
        }

        .asi-time-status{
            width: 100%;
            height: 32px;
            line-height: 29px;
            font-size: 14px;
        }
    }

    
    &:hover{
        border: 1px solid #409EFF;

        .asi-checkbox,.asi-prev-btn{
            display: block;
        }

    }

    &.checked{
        border: 2px solid #409EFF;
    }
}
</style>